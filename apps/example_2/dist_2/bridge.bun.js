// @bun
import{b as A}from"./chunk-q0apy7nk.js";import{d as B,e as q}from"./chunk-8y42hv65.js";function S(){return typeof Bun<"u"}var z=0;async function I(J,K,X,H,L){return new Promise((G,Q)=>{let V=++z;if(H?.aborted){Q(new DOMException("Aborted","AbortError"));return}let Y=(_)=>{let U=_.data;if(U.id!==V)return;if($(),U.ok&&U.data!==void 0)G(U.data);else Q(Error(U.error||"Unknown worker error"))},Z=(_)=>{$(),Q(Error(`Worker error: ${_.message}`))},D=()=>{$(),Q(new DOMException("Aborted","AbortError"))},$=()=>{J.removeEventListener("message",Y),J.removeEventListener("error",Z),H?.removeEventListener("abort",D)};J.addEventListener("message",Y),J.addEventListener("error",Z),H?.addEventListener("abort",D);let O={type:K,id:V,payload:X};if(L&&L.length>0)J.postMessage(O,L);else J.postMessage(O)})}function y(J){let K=J.endsWith(".js")?J:`${J}.js`,X={"resize.worker.js":{package:"@squoosh-kit/resize",specifier:"resize.worker.js"},"webp.worker.js":{package:"@squoosh-kit/webp",specifier:"webp.worker.js"},"avif.worker.js":{package:"@squoosh-kit/avif",specifier:"avif.worker.js"},"mozjpeg.worker.js":{package:"@squoosh-kit/mozjpeg",specifier:"mozjpeg.worker.js"},"jxl.worker.js":{package:"@squoosh-kit/jxl",specifier:"jxl.worker.js"}},H=X[K];if(!H)throw Error(`Unknown worker: ${K}. Supported workers: ${Object.keys(X).join(", ")}`);try{if(typeof window<"u"){let Y=H.package.split("/")[1],Z=K.replace(".js",".browser.mjs"),D=[`../../${Y}/dist/${Z}`,`../../../node_modules/@squoosh-kit/${Y}/dist/${Z}`,`../../../${Y}/dist/${Z}`],$=null;for(let O of D)try{let _=new URL(O,import.meta.url);return new Worker(_,{type:"module"})}catch(_){$=_ instanceof Error?_:Error(String(_))}if($)throw $;throw Error(`Could not resolve worker ${K} using any available path strategy`)}let L=S()?".bun.js":".node.mjs",G=K.replace(".js",""),Q="";if(H.package.includes("resize"))Q=`../../resize/src/${G}.ts`;else if(H.package.includes("webp"))Q=`../../webp/src/${G}.ts`;else if(H.package.includes("avif"))Q=`../../avif/src/${G}.ts`;else if(H.package.includes("mozjpeg"))Q=`../../mozjpeg/src/${G}.ts`;else if(H.package.includes("jxl"))Q=`../../jxl/src/${G}.ts`;if(Q)try{return new Worker(new URL(Q,import.meta.url),{type:"module"})}catch{}let V="";if(H.package.includes("resize"))V=`../../resize/dist/${G}.${L.slice(1)}`;else if(H.package.includes("webp"))V=`../../webp/dist/${G}.${L.slice(1)}`;else if(H.package.includes("avif"))V=`../../avif/dist/${G}.${L.slice(1)}`;else if(H.package.includes("mozjpeg"))V=`../../mozjpeg/dist/${G}.${L.slice(1)}`;else if(H.package.includes("jxl"))V=`../../jxl/dist/${G}.${L.slice(1)}`;if(V)try{return new Worker(new URL(V,import.meta.url),{type:"module"})}catch{}if(typeof import.meta.resolve==="function")try{let Y=import.meta.resolve(`${H.package}/${H.specifier}`);return new Worker(Y,{type:"module"})}catch{}throw Error(`Failed to create worker from ${K}. Tried TypeScript source, dist output, and import.meta.resolve. Ensure the @squoosh-kit/resize and @squoosh-kit/webp packages are installed.`)}catch(L){let G=L instanceof Error?L.message:String(L);throw Error(`Failed to create worker from ${K}: ${G}. Ensure the @squoosh-kit/resize and @squoosh-kit/webp packages are installed. If you're using Vite, ensure the worker files are not being optimized as dependencies.`)}}function x(J,K=1e4){return new Promise((X,H)=>{let L=setTimeout(()=>{H(Error(`Worker initialization timeout after ${K}ms. Worker file: ${J}`))},K),G;try{G=y(J)}catch(Z){clearTimeout(L),H(Z);return}let Q=(Z)=>{if(Z.data?.type==="worker:ready")clearTimeout(L),G.removeEventListener("message",Q),G.removeEventListener("error",V),G.removeEventListener("messageerror",Y),X(G)},V=(Z)=>{clearTimeout(L),G.removeEventListener("message",Q),G.removeEventListener("error",V),G.removeEventListener("messageerror",Y),H(Error(`Worker failed to start: ${Z?.message||"Unknown error"}. Worker file: ${J}`))},Y=()=>{clearTimeout(L),G.removeEventListener("message",Q),G.removeEventListener("error",V),G.removeEventListener("messageerror",Y),H(Error(`Worker message error during initialization. Worker file: ${J}`))};G.addEventListener("message",Q),G.addEventListener("error",V),G.addEventListener("messageerror",Y),G.postMessage({type:"worker:ping"})})}class T{async encode(J,K,X){let L=(await import("./avif.worker.bun.js")).avifEncodeClient;return L(J,K,X)}async decode(J,K){let H=(await import("./avif.worker.bun.js")).avifDecodeClient;return H(J,K)}async terminate(){}}class W{worker=null;workerReady=null;async getWorker(){if(!this.worker){if(!this.workerReady)this.workerReady=this.createWorker();this.worker=await this.workerReady}return this.worker}async createWorker(){return x("avif.worker")}async encode(J,K,X){let H=await this.getWorker();return A(J),I(H,"avif:encode",{image:J,options:K},X)}async decode(J,K){let X=await this.getWorker();return I(X,"avif:decode",{buffer:J},K)}async terminate(){if(this.worker)this.worker.terminate(),this.worker=null,this.workerReady=null}}function N(J){return J==="client"?new T:new W}export{N as createBridge};
export{N as a};

//# debugId=E4F223F1DBC22B0864756E2164756E21
